## file upload with springboot

### 背景
在分布式系统的架构体系下，系统部署之后，文件上传，已经不能够直接存储在当前部署的服务器上，而是有专门的对象存储服务(OSS)，专门负责存储文件。但是对于门户类系统而言，
入参还是文件流，对于图片，还可能是base64的字符，这些始终是不会发生变化的，只是拿到文件之后，是调用OSS-client提供的存储或者访问方法，达到最终对文件操作的目的。

所以门户系统获取文件流，还是写了一个小的demo，只是暂时未部署oss，后续的操作还是按照传统存储在当前服务器上的方式。

但是对于文件的上传，还是有必要做好文件类型的校验。而文件类型的校验，不是单纯的判断后缀方式，众所周知，后缀是可以直接篡改的。在实际的生产场景中，也遇到过不少，将脚本作为图片，
上传至服务器，方便后续借助xss等方式进行攻击。具体例子之前总结的有：
1. [永无止境的安全问题](https://moon-zhou.github.io/2020/09/08/%E6%B0%B8%E6%97%A0%E6%AD%A2%E5%A2%83%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/#more)
2. [20200731生产问题记录-XSS](https://moon-zhou.github.io/2020/07/31/20200731%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95-XSS/)

所以，针对文件类型判断，还是需要借助文件头进行校验，文件头是位于文件开头的一段承担一定任务的数据，一般都在开头的部分，其作用就是为了描述一个文件的一些重要的属性,其可以作为是一类特定文件的标识。

具体的表现形式为，文件在计算机内存储的时候，是二进制格式的数据，而描述这个文件的前XX位（字节）二进制数值，与具体的文件类型是一一对应的。也就在最根本上确定了文件的类型。

### 文件上传
1. 前端页面通过`form-data`上传文件。
2. 后端通过`MultipartFile`来进行文件接收。
3. 如果是多文件上传，前端使用相同的文件名进行上传，后端使用对应文件名的数组进行接收。
4. 接收后，按照现阶段的技术，大部分是存储`OSS`，很少会存储服务器或者数据库。

### 文件下载
读取文件，以流的方式写会客户端。

### 文件删除
直接根据文件标识删除。

### 文件类型校验
1. 确认文件后缀名是否符合要求
2. 确认文件头是否与对应的后缀固定的文件头一致。

在自定义注解的实现方案里，`org.moonzhou.annotation.FileTypeCheck`/`org.moonzhou.validator.FileTypeValidator`。设计了黑名单和白名单的两种模式，且规定不能修改文件后缀，即使修改后的类型依然是支持的类型，也是认为不合法的。

文件头的校验，是借助`hutool`工具类，如果工具类里面不包含自己需要支持的类型，则可以自行进行扩张。可以通过继承实现子类的方式进行扩展：`cn.hutool.core.io.FileTypeUtil.putFileType`。


### 断点续传
// TODO

### 参考